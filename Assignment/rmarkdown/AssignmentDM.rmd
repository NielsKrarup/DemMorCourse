---
title: "Demography and Mortality"
author: "xxx, yyy, zzz, Niels Moctezuma Krarup"
date: "3 october 2021"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
knitr::opts_knit$set(root.dir = "/Users/nielskrarup/Desktop/UNI/courses/DemMorCourse/" )

library("survival")
library("timereg")
library("SASxport")
library("dplyr")
library("purrr")
library("lattice")
library("hexbin")
library("ggplot2")
library(gridExtra)
library(pander)

```


\section{Part 1}
#Part1
Let the setup and notation be as stated in the assignment.

\subsection{1.1)}
## 1.1
From the definition of the expected residual life, $e_i(0) = \int_0^\infty S_i(u|0)du = \int_0^\infty \frac{S_i(u)}{S_i(0)}du = \int_0^\infty S_i(u)du$, since $S_i(0) = 1$. For ease of notation write $M_i = M_i(u) = \int_0^u\mu_i(z)dz, \quad i = 1,2$ we have

\begin{align*}
e_2(0) - e_1(0)  &= \int_0^\infty e^{-M_2}du - \int_0^\infty e^{-M_1}du \\
                 &= \int_0^\infty e^{-M_2} - e^{-M_1}du  \\
                 &= \int_0^\infty \left[  e^{M_1-M_2} - 1\right] e^{-M_1}du 
\end{align*}

Since $e^{-M_1} = S_1(u)$ and noting that 
$$ \frac{d}{du} -S_1(u)e_i(u) = 
\frac{d}{du} -S_1(u)\int_u^\infty \frac{S_1(z)}{S_1(u)}du =
\frac{d}{du} -\int_u^\infty S_1(z)dz = S_1(u),
$$
by the fundamental theorem of calculus and switching limits of the integral. Then using integration by parts we get
\begin{align*}
\int_0^\infty \left[  e^{M_1-M_2} - 1\right] e^{-M_1}du   &= 
\left[ (e^{M_1-M_2}-1)(-S_1(u)e_1(u)) \right]_0^\infty - \int_0^\infty (M_1 - M_2)^\prime e^{M_1 - M_2}(-S_1(u)e_1(u))du     \\
&= \int_0^\infty (\mu_1(u) - \mu_2(u)) e^{\int_0^u \mu_1(v) - \mu_2(v)dv}S_1(u)e_1(u)du
\end{align*}


\section*{1.7)}
## 1.7
```{r}
source(file = "Code/structure.R")
```

Question 1.7: Compute and visualize the period life expectancy at birth for both sexes over the period 1835 − 2020.

We start by creating an HMD object, with Dansih data, and using the corresponding class function "getSmoothMu" to get the smoothed mortality surface.


```{r}

HMDobj <- HMDdatClass$new(Otxtfile = 'Data/DNK_Deaths_1x1.txt', Etxtfile = 'Data/DNK_Exposures_1x1.txt')

surf_obj <- HMDobj$getSmoothMu()
```


From the surf object, we can use the aux-function "surf2lifeexp" to calculate Period life expectancies for all groups, ages = 0, and all times. 
Then plot using the aux-function **life.exp.base** 

```{r, fig.width=12}
lifeexp_obj <- surf2lifeexp(surf = surf_obj, agelim = 0, type = "period")

plot_dat_lifeexp <- reshape2::melt(lifeexp_obj$lifeexp , varnames = c("Group", "Age", "Year"), value.name = "PeriodLifeExp")

ggplot(data = plot_dat_lifeexp, aes(x = Year, y = PeriodLifeExp, fill = Group)) + geom_bar(stat = "identity", position = position_dodge())

ggplot(data = plot_dat_lifeexp, aes(x = Year, y = PeriodLifeExp, col = Group)) + geom_line()
```

\section{1.8}
## 1.8

Question 1.8: Compute and visualize, using e.g. a bar plot, the average annual rate of mortality improvement for both sexes and the age groups and periods stated above.

Mortality improvement rates er defineret i Vaupel & Romo (2003) ligning (4) som $$rho(x,t) = - \frac{d}{dt} log \mu(x,t)$$. Den gennemsnitlige forbedring defineres i ligning (6) som $$\bar{rho}(t) = \int_0^\infty \rho(u,t) \mu(u,t) S(u,t) du$$. Opgaven er således at diskretisere denne udregning, enten direkte p.b.a. definitionen eller ved at sammenvægte mu'erne inden rho beregnes.

